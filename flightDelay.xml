<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>
const int N=4;
const int senderMax=4;
const int valueMax=4;
int msg_value;
int msg_sender;
typedef int[1,senderMax-1] senderDomain;
typedef int[1,valueMax] valueDomain;
int glb_balance[senderMax];
int contract_balance;
chan fun_return;
const int DELAYED_PAYOUT=2;
const int CANCELLED_PAYOUT=2;
const int TICKET_PRICE=2;
const int INSURANCE_PRICE=1;
int owner;
bool InsuranceSet[N];
int claims[N];
int processStatus[N];
int InsuranceLimit[N];
int DepositLimit[N];
bool DepositOk[N];
bool claimStatus[N];
chan buyTicket_fun;
chan refundTicket_fun;
chan buyInsurance_fun;
chan depositInsurance_fun;
chan refundInsurance_fun;
chan claimInsurance_fun;
chan claimPayouts_fun;
typedef int[1,5] flightStatuses_value;
clock InsuranceLimit_clk[N];
clock DepositLimit_clk[N];
int addr;
typedef int[1,N-1] addr_value;
</declaration>
	<template>
		<name>UserModel</name>
		<location id="id0" x="-781" y="-229">
		</location>
		<location id="id1" x="-662" y="-229">
		</location>
		<location id="id2" x="-543" y="-229">
		</location>
		<init ref="id0"/>
		<transition id="id3">
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="assignment" x="-790" y="-280">wait</label>
			<nail x="-807" y="-263"/>
			<nail x="-756" y="-263"/>
		</transition>
		<transition id="id4">
			<source ref="id2"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-722" y="-161">ContractReturn?</label>
			<nail x="-543" y="-144"/>
			<nail x="-781" y="-144"/>
		</transition>
		<transition id="id5">
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="-663" y="-255">contractFlightDelay!</label>
		</transition>
		<transition id="id6">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="assignment" x="-756" y="-272">EOA_addr=addr;
constructor()</label>
		</transition>
	</template>
	<template>
		<name>buyTicket</name>
		<declaration>
</declaration>
		<location id="id7" x="0" y="200">
			<name x="17" y="187">Error</name>
			<committed/>
		</location>
		<location id="id8" x="0" y="0">
		</location>
		<location id="id9" x="100" y="0">
			<committed/>
		</location>
		<location id="id10" x="200" y="0">
			<committed/>
		</location>
		<location id="id11" x="300" y="0">
			<committed/>
		</location>
		<location id="id12" x="400" y="0">
			<name x="390" y="-30">Succ</name>
			<committed/>
		</location>
		<init ref="id8"/>
		<transition id="id13">
			<source ref="id8"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="-8" y="-59">wait</label>
			<nail x="-20" y="-37"/>
			<nail x="30" y="-37"/>
		</transition>
		<transition id="id14">
			<source ref="id8"/>
			<target ref="id9"/>
			<label kind="synchronisation" x="17" y="-25">buyTicket?</label>
		</transition>
		<transition id="id15">
			<source ref="id9"/>
			<target ref="id10"/>
			<label kind="guard" x="68" y="-51">processStatus[msg_sender]!=1</label>
		</transition>
		<transition id="id16">
			<source ref="id9"/>
			<target ref="id7"/>
			<label kind="guard" x="0" y="59">processStatus[msg_sender]==1</label>
		</transition>
		<transition id="id17">
			<source ref="id10"/>
			<target ref="id11"/>
			<label kind="guard" x="170" y="-34">msg_value&gt;=TICKET_PRICE</label>
		</transition>
		<transition id="id18">
			<source ref="id10"/>
			<target ref="id7"/>
			<label kind="guard" x="76" y="76">msg_value&lt;TICKET_PRICE</label>
		</transition>
		<transition id="id19">
			<source ref="id11"/>
			<target ref="id12"/>
			<label kind="assignment" x="365" y="8">InsuranceLimit_clk[msg_sender]=0,
InsuranceLimit[msg_sender]=5,
processStatus[msg_sender]=1,
InsuranceSet[msg_sender]=false</label>
		</transition>
		<transition id="id20">
			<source ref="id12"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="110" y="42">funReturn!</label>
			<label kind="assignment" x="110" y="8">contract_balance+=msg_value,
glb_balance[msg_sender]-=msg_value</label>
			<nail x="0" y="0"/>
		</transition>
		<transition id="id21">
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="-34" y="76">funReturn!</label>
		</transition>
	</template>
	<template>
		<name>buyInsurance</name>
		<declaration>
int status;
</declaration>
		<location id="id22" x="0" y="200">
			<name x="-34" y="170">Error</name>
			<committed/>
		</location>
		<location id="id23" x="0" y="0">
		</location>
		<location id="id24" x="100" y="0">
			<committed/>
		</location>
		<location id="id25" x="200" y="0">
			<committed/>
		</location>
		<location id="id26" x="300" y="0">
			<committed/>
		</location>
		<location id="id27" x="400" y="0">
			<committed/>
		</location>
		<location id="id28" x="500" y="0">
			<committed/>
		</location>
		<location id="id29" x="600" y="0">
			<name x="620" y="-17">Succ</name>
			<committed/>
		</location>
		<init ref="id23"/>
		<transition id="id30">
			<source ref="id23"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="-8" y="-59">wait</label>
			<nail x="-25" y="-42"/>
			<nail x="25" y="-42"/>
		</transition>
		<transition id="id31">
			<source ref="id23"/>
			<target ref="id24"/>
			<label kind="synchronisation" x="17" y="-34">buyInsurance?</label>
		</transition>
		<transition id="id32">
			<source ref="id24"/>
			<target ref="id25"/>
			<label kind="guard" x="85" y="-51">!InsuranceSet[msg_sender]</label>
		</transition>
		<transition id="id33">
			<source ref="id24"/>
			<target ref="id22"/>
			<label kind="guard" x="0" y="59">InsuranceSet[msg_sender]</label>
		</transition>
		<transition id="id34">
			<source ref="id25"/>
			<target ref="id26"/>
			<label kind="guard" x="187" y="-34">processStatus[msg_sender]==1</label>
		</transition>
		<transition id="id35">
			<source ref="id25"/>
			<target ref="id22"/>
			<label kind="guard" x="51" y="76">processStatus[msg_sender]!=1</label>
		</transition>
		<transition id="id36">
			<source ref="id26"/>
			<target ref="id27"/>
			<label kind="guard" x="272" y="-51">InsuranceLimit_clk[msg_sender]&lt;=InsuranceLimit[msg_sender]</label>
		</transition>
		<transition id="id37">
			<source ref="id26"/>
			<target ref="id22"/>
			<label kind="guard" x="76" y="93">InsuranceLimit_clk[msg_sender]&gt;InsuranceLimit[msg_sender]</label>
		</transition>
		<transition id="id38">
			<source ref="id27"/>
			<target ref="id28"/>
			<label kind="guard" x="391" y="-34">msg_value&gt;=INSURANCE_PRICE</label>
		</transition>
		<transition id="id39">
			<source ref="id27"/>
			<target ref="id22"/>
			<label kind="guard" x="153" y="110">msg_value&lt;INSURANCE_PRICE</label>
		</transition>
		<transition id="id40">
			<source ref="id28"/>
			<target ref="id29"/>
			<label kind="assignment" x="510" y="17">InsuranceSet[msg_sender]=true;
claimStatus[msg_sender]=false;
DepositLimit_clk[msg_sender]=0;
DepositLimit[msg_sender]=30;
DepositOk[msg_sender]=false</label>
		</transition>
		<transition id="id41">
			<source ref="id29"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="204" y="42">funReturn!</label>
			<label kind="assignment" x="204" y="8">contract_balance+=msg_value,
glb_balance[msg_sender]-=msg_value</label>
			<nail x="0" y="0"/>
		</transition>
		<transition id="id42">
			<source ref="id22"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="-34" y="42">funReturn!</label>
		</transition>
	</template>
	<template>
		<name>depositInsurance</name>
		<declaration>
</declaration>
		<location id="id43" x="0" y="200">
			<name x="-34" y="170">Error</name>
			<committed/>
		</location>
		<location id="id44" x="0" y="0">
		</location>
		<location id="id45" x="100" y="0">
			<committed/>
		</location>
		<location id="id46" x="200" y="0">
			<committed/>
		</location>
		<location id="id47" x="300" y="0">
			<committed/>
		</location>
		<location id="id48" x="400" y="0">
			<committed/>
		</location>
		<location id="id49" x="500" y="0">
			<committed/>
		</location>
		<location id="id50" x="600" y="0">
			<committed/>
		</location>
		<location id="id51" x="700" y="0">
			<committed/>
		</location>
		<location id="id52" x="800" y="0">
			<name x="790" y="-30">Succ</name>
			<committed/>
		</location>
		<init ref="id44"/>
		<transition id="id53">
			<source ref="id44"/>
			<target ref="id44"/>
			<label kind="synchronisation" x="-8" y="-59">wait</label>
			<nail x="-25" y="-42"/>
			<nail x="25" y="-42"/>
		</transition>
		<transition id="id54">
			<source ref="id44"/>
			<target ref="id45"/>
			<label kind="synchronisation" x="17" y="-34">depositInsurance_fun?</label>
		</transition>
		<transition id="id55">
			<source ref="id45"/>
			<target ref="id46"/>
			<label kind="guard" x="85" y="-51">owner==msg_sender</label>
		</transition>
		<transition id="id56">
			<source ref="id45"/>
			<target ref="id43"/>
			<label kind="guard" x="8" y="59">owner!=msg_sender</label>
		</transition>
		<transition id="id57">
			<source ref="id46"/>
			<target ref="id47"/>
			<label kind="guard" x="187" y="-34">!DepositOk[addr]</label>
		</transition>
		<transition id="id58">
			<source ref="id46"/>
			<target ref="id43"/>
			<label kind="guard" x="51" y="76">DepositOk[addr]</label>
		</transition>
		<transition id="id59">
			<source ref="id47"/>
			<target ref="id48"/>
			<label kind="guard" x="280" y="-51">processStatus[addr]==1</label>
		</transition>
		<transition id="id60">
			<source ref="id47"/>
			<target ref="id43"/>
			<label kind="guard" x="85" y="85">processStatus[addr]!=1</label>
		</transition>
		<transition id="id61">
			<source ref="id48"/>
			<target ref="id49"/>
			<label kind="guard" x="391" y="-34">InsuranceSet[addr]</label>
		</transition>
		<transition id="id62">
			<source ref="id48"/>
			<target ref="id43"/>
			<label kind="guard" x="127" y="102">!(InsuranceSet[addr])</label>
		</transition>
		<transition id="id63">
			<source ref="id49"/>
			<target ref="id50"/>
			<label kind="guard" x="450" y="-51">DepositLimit_clk[addr]&lt;=DepositLimit[addr]</label>
		</transition>
		<transition id="id64">
			<source ref="id49"/>
			<target ref="id43"/>
			<label kind="guard" x="144" y="119">DepositLimit_clk[addr]&gt;DepositLimit[addr]</label>
		</transition>
		<transition id="id65">
			<source ref="id50"/>
			<target ref="id51"/>
			<label kind="guard" x="595" y="-34">msg_value&gt;=2</label>
		</transition>
		<transition id="id66">
			<source ref="id50"/>
			<target ref="id43"/>
			<label kind="guard" x="195" y="136">msg_value&lt;2</label>
		</transition>
		<transition id="id67">
			<source ref="id51"/>
			<target ref="id52"/>
			<label kind="assignment" x="697" y="17">DepositOk[addr]=true</label>
		</transition>
		<transition id="id68">
			<source ref="id52"/>
			<target ref="id44"/>
			<label kind="synchronisation" x="331" y="42">funReturn!</label>
			<label kind="assignment" x="331" y="8">contract_balance+=msg_value,
glb_balance[msg_sender]-=msg_value</label>
			<nail x="0" y="0"/>
		</transition>
		<transition id="id69">
			<source ref="id43"/>
			<target ref="id44"/>
			<label kind="synchronisation" x="-17" y="42">funReturn!</label>
		</transition>
	</template>
	<template>
		<name>claimInsurance</name>
		<declaration>
int payout;
int status;
</declaration>
		<location id="id70" x="0" y="200">
			<name x="17" y="195">Error</name>
			<committed/>
		</location>
		<location id="id71" x="0" y="0">
		</location>
		<location id="id72" x="100" y="0">
			<committed/>
		</location>
		<location id="id73" x="200" y="0">
			<committed/>
		</location>
		<location id="id74" x="300" y="0">
			<committed/>
		</location>
		<location id="id75" x="400" y="0">
			<committed/>
		</location>
		<location id="id76" x="500" y="0">
			<committed/>
		</location>
		<location id="id77" x="600" y="0">
			<committed/>
		</location>
		<location id="id78" x="500" y="-100">
			<committed/>
		</location>
		<location id="id79" x="700" y="0">
			<committed/>
		</location>
		<location id="id80" x="600" y="-100">
			<committed/>
		</location>
		<location id="id81" x="800" y="0">
			<committed/>
		</location>
		<location id="id82" x="700" y="-100">
			<committed/>
		</location>
		<location id="id83" x="600" y="-100">
			<committed/>
		</location>
		<location id="id84" x="900" y="0">
			<name x="890" y="-30">Succ</name>
			<committed/>
		</location>
		<init ref="id71"/>
		<transition id="id85">
			<source ref="id71"/>
			<target ref="id71"/>
			<label kind="synchronisation" x="-17" y="-59">wait</label>
			<nail x="-25" y="-42"/>
			<nail x="25" y="-42"/>
		</transition>
		<transition id="id86">
			<source ref="id71"/>
			<target ref="id72"/>
			<label kind="synchronisation" x="17" y="-34">claimInsurance_fun?</label>
		</transition>
		<transition id="id87">
			<source ref="id72"/>
			<target ref="id73"/>
			<label kind="guard" x="85" y="-51">processStatus[msg_sender]==1</label>
		</transition>
		<transition id="id88">
			<source ref="id72"/>
			<target ref="id70"/>
			<label kind="guard" x="8" y="59">processStatus[msg_sender]!=1</label>
		</transition>
		<transition id="id89">
			<source ref="id73"/>
			<target ref="id74"/>
			<label kind="guard" x="187" y="-34">InsuranceSet[msg_sender]</label>
		</transition>
		<transition id="id90">
			<source ref="id73"/>
			<target ref="id70"/>
			<label kind="guard" x="76" y="76">!(InsuranceSet[msg_sender])</label>
		</transition>
		<transition id="id91">
			<source ref="id74"/>
			<target ref="id75"/>
			<label kind="select" x="297" y="-51">e:flightStatuses_value</label>
			<label kind="assignment" x="314" y="0">status=e</label>
		</transition>
		<transition id="id92">
			<source ref="id75"/>
			<target ref="id76"/>
			<label kind="guard" x="391" y="-34">status==4||status==5</label>
		</transition>
		<transition id="id93">
			<source ref="id75"/>
			<target ref="id70"/>
			<label kind="guard" x="153" y="93">status!=4&amp;&amp;status!=5</label>
		</transition>
		<transition id="id94">
			<source ref="id76"/>
			<target ref="id77"/>
			<label kind="guard" x="459" y="8">!claimStatus[msg_sender]</label>
		</transition>
		<transition id="id95">
			<source ref="id77"/>
			<target ref="id79"/>
			<label kind="guard" x="629" y="8">status==4</label>
		</transition>
		<transition id="id96">
			<source ref="id79"/>
			<target ref="id81"/>
			<label kind="assignment" x="646" y="-51">payout=DELAYED_PAYOUT+INSURANCE_PRICE,
claims[owner]+=TICKET_PRICE</label>
		</transition>
		<transition id="id97">
			<source ref="id77"/>
			<target ref="id80"/>
			<label kind="guard" x="535" y="-76">status!=4</label>
		</transition>
		<transition id="id98">
			<source ref="id80"/>
			<target ref="id82"/>
			<label kind="assignment" x="603" y="-93">payout=CANCELLED_PAYOUT+INSURANCE_PRICE,
claims[owner]+=TICKET_PRICE</label>
		</transition>
		<transition id="id99">
			<source ref="id82"/>
			<target ref="id81"/>
		</transition>
		<transition id="id100">
			<source ref="id76"/>
			<target ref="id78"/>
			<label kind="guard" x="365" y="-76">claimStatus[msg_sender]</label>
		</transition>
		<transition id="id101">
			<source ref="id78"/>
			<target ref="id83"/>
			<label kind="assignment" x="467" y="-127">payout=0,claims[owner]+=DELAYED_PAYOUT+TICKET_PRICE</label>
		</transition>
		<transition id="id102">
			<source ref="id83"/>
			<target ref="id81"/>
		</transition>
		<transition id="id103">
			<source ref="id81"/>
			<target ref="id84"/>
			<label kind="assignment" x="765" y="8">claimStatus[msg_sender]=true,
claims[msg_sender]+=payout</label>
		</transition>
		<transition id="id104">
			<source ref="id84"/>
			<target ref="id71"/>
			<label kind="synchronisation" x="399" y="34">funReturn!</label>
			<nail x="0" y="0"/>
		</transition>
		<transition id="id105">
			<source ref="id70"/>
			<target ref="id71"/>
			<label kind="synchronisation" x="-25" y="42">funReturn!</label>
		</transition>
	</template>
	<template>
		<name>claimPayouts</name>
		<declaration>
int payout;
</declaration>
		<location id="id106" x="0" y="200">
			<name x="17" y="187">Error</name>
			<committed/>
		</location>
		<location id="id107" x="0" y="0">
		</location>
		<location id="id108" x="102" y="0">
			<committed/>
		</location>
		<location id="id109" x="200" y="0">
			<committed/>
		</location>
		<location id="id110" x="300" y="0">
			<committed/>
		</location>
		<location id="id111" x="400" y="0">
			<name x="390" y="-30">Succ</name>
			<committed/>
		</location>
		<init ref="id107"/>
		<transition id="id112">
			<source ref="id107"/>
			<target ref="id107"/>
			<label kind="synchronisation" x="-8" y="-59">wait</label>
			<nail x="-25" y="-42"/>
			<nail x="25" y="-42"/>
		</transition>
		<transition id="id113">
			<source ref="id107"/>
			<target ref="id108"/>
			<label kind="synchronisation" x="17" y="-34">claimPayouts_fun?</label>
		</transition>
		<transition id="id114">
			<source ref="id108"/>
			<target ref="id109"/>
			<label kind="assignment" x="51" y="8">payout=claims[msg_sender]</label>
		</transition>
		<transition id="id115">
			<source ref="id109"/>
			<target ref="id110"/>
			<label kind="assignment" x="161" y="-51">glb_balance[msg_sender]+=payout,
contract_balance-=payout</label>
		</transition>
		<transition id="id116">
			<source ref="id109"/>
			<target ref="id106"/>
		</transition>
		<transition id="id117">
			<source ref="id110"/>
			<target ref="id111"/>
			<label kind="assignment" x="280" y="8">claims[msg_sender]=0</label>
		</transition>
		<transition id="id118">
			<source ref="id111"/>
			<target ref="id107"/>
			<label kind="synchronisation" x="187" y="34">funReturn!</label>
			<nail x="0" y="0"/>
		</transition>
		<transition id="id119">
			<source ref="id106"/>
			<target ref="id107"/>
			<label kind="synchronisation" x="0" y="51">funReturn!</label>
		</transition>
	</template>
	<template>
		<name>ContractGlobalModel</name>
		<declaration>
void initial(){
    int i;
    for(i=0;i&lt;senderMax;i++)
        glb_balance[i]=10;
}
void constructor(){
        owner=msg_sender;
}
int updateMax(int x,int y){
    if(x &gt;= y)
        return x;
    return y;
}
int updateMin(int x,int y){
    if(x &gt;= y)
        return y;
    return x;
}
</declaration>
		<location id="id120" x="-960" y="-399">
		</location>
		<location id="id121" x="-773" y="-399">
		</location>
		<location id="id122" x="-867" y="-399">
			<committed/>
		</location>
		<location id="id123" x="-985" y="-493">
			<name x="-1044" y="-527">buyTicket_running</name>
			<committed/>
		</location>
		<location id="id124" x="-909" y="-527">
			<name x="-985" y="-561">buyInsurance_running</name>
			<committed/>
		</location>
		<location id="id125" x="-824" y="-561">
			<name x="-900" y="-595">depositInsurance_running</name>
			<committed/>
		</location>
		<location id="id126" x="-739" y="-527">
			<name x="-798" y="-561">claimInsurance_running</name>
			<committed/>
		</location>
		<location id="id127" x="-671" y="-493">
			<name x="-722" y="-527">claimPayouts_running</name>
			<committed/>
		</location>
		<init ref="id120"/>
		<transition id="id128">
			<source ref="id121"/>
			<target ref="id120"/>
			<label kind="synchronisation" x="-942" y="-348">ContractReturn!</label>
			<nail x="-773" y="-331"/>
			<nail x="-960" y="-331"/>
		</transition>
		<transition id="id129">
			<source ref="id120"/>
			<target ref="id122"/>
			<label kind="synchronisation" x="-968" y="-391">contractFlightDelay?</label>
		</transition>
		<transition id="id130">
			<source ref="id120"/>
			<target ref="id120"/>
			<label kind="assignment" x="-969" y="-450">wait</label>
			<nail x="-985" y="-433"/>
			<nail x="-934" y="-433"/>
		</transition>
		<transition id="id131">
			<source ref="id121"/>
			<target ref="id122"/>
		</transition>
		<transition id="id132">
			<source ref="id122"/>
			<target ref="id123"/>
			<label kind="synchronisation" x="-943" y="-459">buyTicket!</label>
		</transition>
		<transition id="id133">
			<source ref="id123"/>
			<target ref="id121"/>
			<label kind="synchronisation" x="-960" y="-467">fun_return?</label>
		</transition>
		<transition id="id134">
			<source ref="id122"/>
			<target ref="id124"/>
			<label kind="synchronisation" x="-917" y="-493">buyInsurance!</label>
		</transition>
		<transition id="id135">
			<source ref="id124"/>
			<target ref="id121"/>
			<label kind="synchronisation" x="-867" y="-510">fun_return?</label>
		</transition>
		<transition id="id136">
			<source ref="id122"/>
			<target ref="id125"/>
			<label kind="select" x="-875" y="-544">para1:addr_value</label>
			<label kind="synchronisation" x="-875" y="-529">depositInsurance!</label>
			<label kind="assignment" x="-875" y="-518">addr=para1</label>
		</transition>
		<transition id="id137">
			<source ref="id125"/>
			<target ref="id121"/>
			<label kind="synchronisation" x="-909" y="-484">fun_return?</label>
		</transition>
		<transition id="id138">
			<source ref="id122"/>
			<target ref="id126"/>
			<label kind="synchronisation" x="-764" y="-467">claimInsurance!</label>
		</transition>
		<transition id="id139">
			<source ref="id126"/>
			<target ref="id121"/>
			<label kind="synchronisation" x="-747" y="-459">fun_return?</label>
		</transition>
		<transition id="id140">
			<source ref="id122"/>
			<target ref="id127"/>
			<label kind="synchronisation" x="-807" y="-493">claimPayouts!</label>
		</transition>
		<transition id="id141">
			<source ref="id127"/>
			<target ref="id121"/>
			<label kind="synchronisation" x="-807" y="-484">fun_return?</label>
		</transition>
	</template>
	<system>system UserModel,ContractGlobalModel,buyTicket,buyInsurance,depositInsurance,claimInsurance,claimPayouts;
</system>
	<queries>
		<query>
			<formula/>
			<comment/>
		</query>
	</queries>
</nta>
